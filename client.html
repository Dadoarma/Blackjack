<!DOCTYPE html>
<html>
<head>
    <title>Blackjack</title>
    <style>
        :root {
            --bg-color: #2e7d32;
            --card-color: white;
            --card-back-color: #1565c0;
            --primary-color: #4caf50;
            --secondary-color: #ffeb3b;
            --danger-color: #d32f2f;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--card-color);
            text-align: center;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { font-size: 2.5em; margin-bottom: 20px; color: var(--secondary-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .hidden { display: none; }
        .lobby-box, #game { background: #1b5e20; padding: 30px; border-radius: 12px; max-width: 90%; width: 450px; margin: 20px auto; box-shadow: var(--shadow-light); }
        .lobby-box input { padding: 10px; font-size: 16px; margin: 10px 0; width: 80%; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; text-transform: uppercase; }
        #table-code { background: var(--primary-color); padding: 10px; border-radius: 6px; margin: 15px 0; font-size: 1.1em; font-weight: bold; letter-spacing: 1px; }
        button { margin: 8px; padding: 12px 24px; font-size: 16px; border: none; border-radius: 25px; cursor: pointer; background: var(--primary-color); color: white; transition: background 0.3s, opacity 0.3s; font-weight: bold; box-shadow: 0 4px 0 #388e3c; }
        button:hover:not(:disabled) { background: #388e3c; box-shadow: 0 2px 0 #388e3c; transform: translateY(2px); }
        button:disabled { background: #666; cursor: not-allowed; box-shadow: none; opacity: 0.7; transform: translateY(0); }
        .leave { background: var(--danger-color); box-shadow: 0 4px 0 #9f2424; }
        .leave:hover:not(:disabled) { background: #9f2424; box-shadow: 0 2px 0 #9f2424; }
        .card { display: inline-block; margin: 6px; padding: 15px 18px; background: var(--card-color); color: black; border-radius: 8px; font-size: 24px; font-weight: bold; box-shadow: var(--shadow-light); min-width: 30px; transition: transform 0.4s ease-out; border: 1px solid #aaa; }
        .card.hidden { background: var(--card-back-color); color: var(--card-back-color); border: 1px solid var(--card-back-color); position: relative; }
        .card.hidden::before { content: '‚ô†'; color: white; font-size: 1.5em; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .cards { margin: 20px 0; min-height: 80px; }
        .value { font-size: 1.2em; color: var(--secondary-color); margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>
<h1>üé∞ Blackjack Live</h1>

<div id="lobby">
    <div class="lobby-box">
        <h2>Welcome!</h2>
        <button onclick="connect('CREATE')">Create Table</button>
        <hr>
        <input id="code" placeholder="Enter 6-char code" maxlength="6">
        <button onclick="connect('JOIN ' + document.getElementById('code').value.toUpperCase())">Join Table</button>
    </div>
</div>

<div id="game" class="hidden">
    <div id="table-code"></div>
    <div id="waiting" class="value hidden">‚è≥ Sei in attesa, parteciperai al prossimo round</div>
    <h3>Dealer</h3>
    <div id="dval" class="value"></div>
    <div id="dcards" class="cards"></div>
    <h3>Player</h3>
    <div id="pval" class="value"></div>
    <div id="pcards" class="cards"></div>
    <div id="status" class="value"></div>
    <div class="actions">
        <button id="hit" onclick="send('HIT')" disabled>HIT</button>
        <button id="stand" onclick="send('STAND')" disabled>STAND</button>
        <button id="again" onclick="send('YES')" disabled>PLAY AGAIN</button>
    </div>
    <button class="leave" onclick="leave()">LEAVE</button>
</div>

<script>
const [lobby, game, pcards, dcards, pval, dval, hit, stand, again, statusEl, waiting] = 
['lobby', 'game', 'pcards', 'dcards', 'pval', 'dval', 'hit', 'stand', 'again', 'status', 'waiting'].map(id => document.getElementById(id));

let ws, play = false, pc = [], dc = [];

function connect(msg) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    ws = new WebSocket(`${protocol}//${host}`);

    ws.onopen = () => ws.send(msg);

    ws.onmessage = async e => {
        const raw = e.data;
        const [cmd, payload] = raw.split(' ', 2);

        if (cmd.startsWith("TABLE_")) {
            if (cmd === "TABLE_CREATED" || cmd === "TABLE_JOINED") {
                lobby.classList.add("hidden");
                game.classList.remove("hidden");
                document.getElementById("table-code").textContent = "Code: " + payload;
            } else if (cmd === "TABLE_NOT_FOUND") alert("Table not found!");
            else if (cmd === "TABLE_FULL") alert("Table full!");
        } 
        else if (cmd === "PLAY_AGAIN_LOCK") {
            waiting.classList.remove("hidden");
            btns(false, false, false);
        }
        else if (cmd === "PLAY_AGAIN?") {
            waiting.classList.add("hidden");
            again.disabled = false;
            hit.disabled = true;
            stand.disabled = true;
            play = false;
        }
        else if (cmd === "CARDS") {
            const cards = payload ? payload.split(",") : [];
            for (let c of cards.slice(pc.length)) {
                add(pcards, c);
                await wait(400);
            }
            pc = cards;
            update(pval, pc);
        }
        else if (cmd === "DEALER_RESET") {
            dcards.innerHTML = dval.textContent = "";
            pcards.innerHTML = pval.textContent = "";
            statusEl.textContent = "";
            dc = pc = [];
        }
        else if (cmd === "DEALER_INIT") {
            const parts = payload ? payload.split(" ") : [];
            dcards.innerHTML = "";
            dc = [];

            // parts[0] = carta COPERTA (non la mostriamo)
            // parts[1] = carta VISIBILE (la mostriamo)
            
            if (parts[0]) {
                // Prima carta: COPERTA - mostriamo solo il retro
                dc.push(parts[0]); // salviamo per dopo
                add(dcards, "", true); // carta blu senza testo
            }
            if (parts[1]) {
                // Seconda carta: VISIBILE
                dc.push(parts[1]);
                add(dcards, parts[1]); // carta bianca con valore
            }

            // Mostra solo il valore della carta visibile (la seconda)
            const visibleValue = parts[1] ? val(parts[1]) : 0;
            dval.textContent = "Showing: " + visibleValue;
        }
        else if (cmd === "YOUR_TURN") {
            play = true;
            waiting.classList.add("hidden");
            btns(true, true, false);
        }
        else if (cmd === "DEALER_REVEAL") {
            // Rivela la prima carta (quella coperta in posizione 0)
            if (dcards.children[0]) {
                dcards.children[0].textContent = dc[0] || "?";
                dcards.children[0].classList.remove("hidden");
            }
            update(dval, dc);
            await wait(500);
        }
        else if (cmd === "DEALER_CARD") {
            if (payload) {
                dc.push(payload);
                add(dcards, payload);
                await wait(400);
                update(dval, dc);
            }
        }
        else if (cmd === "RESULT") {
            play = false;
            btns(false, false, false);
            const parts = payload ? payload.split(" ") : [];
            const result = parts[0] || "";
            const dealerIndex = parts.indexOf("DEALER");
            let dealerCardsStr = "";
            if (dealerIndex !== -1) dealerCardsStr = parts.slice(dealerIndex + 1).join(" ");
            statusEl.textContent = result ? ("Result: " + result) : "";
            if (dealerCardsStr) {
                const finalDealerCards = dealerCardsStr.split(",").map(s => s.trim()).filter(Boolean);
                dcards.innerHTML = "";
                dc = [];
                for (const card of finalDealerCards) { dc.push(card); add(dcards, card); }
                update(dval, dc);
            }
        }
    };
}

function send(m) {
    if (ws && ws.readyState !== 1) return;
    if (m === "YES" && again.disabled) return;
    if (m === "HIT" && hit.disabled) return;
    if (m === "STAND" && stand.disabled) return;
    ws.send(m);
    if (m === "HIT" || m === "STAND") {
        play = false;
        btns(false, false, false);
    } else if (m === "YES") {
        again.disabled = true;
    }
}

function leave() {
    if (ws) ws.close();
    game.classList.add("hidden");
    lobby.classList.remove("hidden");
    dcards.innerHTML = pcards.innerHTML = "";
    dval.textContent = pval.textContent = "";
    statusEl.textContent = "";
    waiting.classList.add("hidden");
    dc = pc = [];
}

function btns(h, s, a) {
    hit.disabled = !h;
    stand.disabled = !s;
    again.disabled = !a;
}

function add(el, txt, hid) {
    const d = document.createElement("div");
    d.className = "card" + (hid ? " hidden" : "");
    d.textContent = hid ? "" : txt;
    el.appendChild(d);
}

function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

function val(c) {
    const v = c.slice(0, -1);
    return v === "A" ? 11 : ["J","Q","K"].includes(v) ? 10 : +v;
}

function sum(cards) {
    let s = 0, a = 0;
    for (let c of cards) {
        const v = c.slice(0, -1);
        if (v === "A") { s += 11; a++; }
        else s += ["J","Q","K"].includes(v) ? 10 : +v;
    }
    while (s > 21 && a > 0) { s -= 10; a--; }
    return s;
}

function update(el, cards) {
    const s = sum(cards);
    el.textContent = "Value: " + s + (s>21 ? " - BUST!" : s===21 ? " - BLACKJACK!" : "");
}
</script>
</body>
</html>