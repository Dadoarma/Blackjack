<!DOCTYPE html>
<html>
<head>
    <title>Blackjack</title>
    <style>
        :root {
            --bg-color: #2e7d32; /* Sfondo del tavolo */
            --card-color: white;
            --card-back-color: #1565c0; /* Blu scuro */
            --primary-color: #4caf50;
            --secondary-color: #ffeb3b;
            --danger-color: #d32f2f;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-color); 
            color: var(--card-color); 
            text-align: center; 
            padding: 20px; 
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: var(--secondary-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* --- Struttura Generale --- */
        .hidden { display: none; }
        .lobby-box, #game { 
            background: #1b5e20; /* Verde scuro, base */
            padding: 30px; 
            border-radius: 12px; 
            max-width: 90%;
            width: 450px; 
            margin: 20px auto; 
            box-shadow: var(--shadow-light);
        }
        
        /* --- Lobby --- */
        .lobby-box input { 
            padding: 10px; 
            font-size: 16px; 
            margin: 10px 0; 
            width: 80%; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            box-sizing: border-box;
            text-transform: uppercase;
        }
        
        /* --- Codice Tavolo --- */
        #table-code { 
            background: var(--primary-color); 
            padding: 10px; 
            border-radius: 6px; 
            margin: 15px 0; 
            font-size: 1.1em; 
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* --- Bottoni --- */
        button { 
            margin: 8px; 
            padding: 12px 24px; 
            font-size: 16px; 
            border: none; 
            border-radius: 25px; /* Pulsanti arrotondati */
            cursor: pointer; 
            background: var(--primary-color); 
            color: white; 
            transition: background 0.3s, opacity 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 0 #388e3c; /* Ombra 3D */
        }
        button:hover:not(:disabled) { 
            background: #388e3c; 
            box-shadow: 0 2px 0 #388e3c;
            transform: translateY(2px);
        }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
            box-shadow: none;
            opacity: 0.7;
            transform: translateY(0);
        }
        .leave { 
            background: var(--danger-color); 
            box-shadow: 0 4px 0 #9f2424;
        }
        .leave:hover:not(:disabled) { 
            background: #9f2424; 
            box-shadow: 0 2px 0 #9f2424;
        }
        
        /* --- Carte --- */
        .card { 
            display: inline-block; 
            margin: 6px; 
            padding: 15px 18px; 
            background: var(--card-color); 
            color: black; 
            border-radius: 8px; 
            font-size: 24px; 
            font-weight: bold;
            box-shadow: var(--shadow-light); 
            min-width: 30px; 
            transition: transform 0.4s ease-out;
            border: 1px solid #aaa;
        }
        .card.hidden { 
            background: var(--card-back-color); 
            color: var(--card-back-color); /* Nasconde il seme */
            border: 1px solid var(--card-back-color);
            position: relative;
        }
        .card.hidden::before {
             content: 'â™ '; /* Simbolo sul dorso */
             color: white;
             font-size: 1.5em;
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
        }
        .cards { 
            margin: 20px 0; 
            min-height: 80px; 
        }
        .value { 
            font-size: 1.2em; 
            color: var(--secondary-color); 
            margin: 10px 0; 
            font-weight: bold;
        }

        /* --- Log di Debug --- */
        #log {
            background: rgba(0, 0, 0, 0.4);
            color: #ccc;
            padding: 10px;
            margin-top: 25px;
            text-align: left;
            height: 120px;
            overflow-y: scroll;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 12px;
            width: 90%;
            max-width: 450px;
        }
    </style>
</head>
<body>
<h1>ðŸŽ° Blackjack Live</h1>

<div id="lobby">
    <div class="lobby-box">
        <h2>Welcome!</h2>
        <button onclick="connect('CREATE')">Create Table</button>
        <hr>
        <input id="code" placeholder="Enter 6-char code" maxlength="6">
        <button onclick="connect('JOIN ' + document.getElementById('code').value.toUpperCase())">Join Table</button>
    </div>
</div>

<div id="game" class="hidden">
    <div id="table-code"></div>
    <h3>Dealer</h3>
    <div id="dval" class="value"></div>
    <div id="dcards" class="cards"></div>
    <h3>Player</h3>
    <div id="pval" class="value"></div>
    <div id="pcards" class="cards"></div>
    
    <div class="actions">
        <button id="hit" onclick="send('HIT')" disabled>HIT</button>
        <button id="stand" onclick="send('STAND')" disabled>STAND</button>
        <button id="again" onclick="send('YES')" disabled>PLAY AGAIN</button>
    </div>
    <button class="leave" onclick="leave()">LEAVE</button>
    <div id="log"></div>
</div>

<script>
// Riferimenti agli elementi (per evitare document.getElementById ripetuti)
const lobby = document.getElementById('lobby');
const game = document.getElementById('game');
const pcards = document.getElementById('pcards');
const dcards = document.getElementById('dcards');
const pval = document.getElementById('pval');
const dval = document.getElementById('dval');
const hit = document.getElementById('hit');
const stand = document.getElementById('stand');
const again = document.getElementById('again');

let ws, play = false, pc = [], dc = [];

function connect(msg) {
    // Connessione dinamica (essenziale per Render)
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    ws = new WebSocket(`${protocol}//${host}`);
    
    ws.onopen = () => ws.send(msg);
    ws.onmessage = async e => {
        const d = e.data;
        log(d);
        
        if (d.startsWith("TABLE_CREATED") || d.startsWith("TABLE_JOINED")) {
            lobby.classList.add("hidden");
            game.classList.remove("hidden");
            document.getElementById("table-code").textContent = "Code: " + d.split(" ")[1];
        } else if (d === "TABLE_NOT_FOUND") {
            alert("Table not found!");
        } else if (d === "TABLE_FULL") {
            alert("Table full!");
        } else if (d.startsWith("CARDS")) {
            const cards = d.split(" ")[1].split(",");
            for (let c of cards.slice(pc.length)) {
                add(pcards, c);
                await wait(400);
            }
            pc = cards;
            update(pval, pc);
        } else if (d === "DEALER_RESET") {
            dcards.innerHTML = "";
            dc = [];
            dval.textContent = "";
        } else if (d.startsWith("DEALER_INIT")) {
            const p = d.split(" ");
            dc = [p[1], p[2]];
            dcards.innerHTML = "";
            add(dcards, "ðŸ‚ ", true);
            await wait(400);
            add(dcards, p[2]);
            dval.textContent = "Showing: " + val(p[2]);
        } else if (d === "YOUR_TURN") {
            play = true;
            btns(true, true, false);
        } else if (d === "DEALER_REVEAL") {
            dcards.children[0].textContent = dc[0];
            dcards.children[0].classList.remove("hidden");
            update(dval, dc);
            await wait(500);
        } else if (d.startsWith("DEALER_CARD")) {
            const c = d.split(" ")[1];
            dc.push(c);
            add(dcards, c);
            await wait(400);
            update(dval, dc);
        } else if (d.startsWith("RESULT")) {
            play = false;
            btns(false, false, false);
            const resultStatus = d.split(" ")[1]; 
            log((resultStatus.includes("WIN") ? "ðŸŽ‰" : resultStatus.includes("LOSE") ? "ðŸ˜ž" : "ðŸ¤") + " " + resultStatus);
        } else if (d === "PLAY_AGAIN?") {
            play = false;
            btns(false, false, true);
        }
    };
}

function send(m) {
    if (ws && ws.readyState !== 1) { log("Error: WebSocket not connected."); return; }
    if (!play && m !== "YES") return;
    ws.send(m);
    log("> " + m);
    if (m === "HIT" || m === "STAND") {
        play = false;
        btns(false, false, false);
    } else if (m === "YES") {
        pc = dc = [];
        pcards.innerHTML = dcards.innerHTML = "";
        pval.textContent = dval.textContent = "";
    }
}

function leave() {
    if (ws) ws.close();
    game.classList.add("hidden");
    lobby.classList.remove("hidden");
    pc = dc = [];
    pcards.innerHTML = dcards.innerHTML = "";
    pval.textContent = dval.textContent = "";
    document.getElementById("log").textContent = "";
}

function btns(h, s, a) {
    hit.disabled = !h;
    stand.disabled = !s;
    again.disabled = !a;
}

function add(el, txt, hid) {
    const d = document.createElement("div");
    d.className = "card" + (hid ? " hidden" : "");
    d.textContent = txt;
    el.appendChild(d);
}

function log(t) {
    const logEl = document.getElementById("log");
    logEl.textContent += t + "\n";
    logEl.scrollTop = logEl.scrollHeight; // Scrolla in fondo
}

function wait(ms) {
    return new Promise(r => setTimeout(r, ms));
}

function val(c) {
    const v = c.slice(0, -1);
    return v === "A" ? 11 : ["J", "Q", "K"].includes(v) ? 10 : +v;
}

function sum(cards) {
    let s = 0, a = 0;
    for (let c of cards) {
        const v = c.slice(0, -1);
        if (v === "A") { s += 11; a++; }
        else s += ["J", "Q", "K"].includes(v) ? 10 : +v;
    }
    while (s > 21 && a > 0) { s -= 10; a--; }
    return s;
}

function update(el, cards) {
    const s = sum(cards);
    el.textContent = "Value: " + s + (s > 21 ? " - BUST!" : s === 21 ? " - BLACKJACK!" : "");
}
</script>
</body>
</html>