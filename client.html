<!DOCTYPE html>
<html>
<head>
    <title>Blackjack</title>
    <style>
        body { font-family: Arial; background: #2e7d32; color: white; text-align: center; padding: 20px; }
        .hidden { display: none; }
        .lobby-box { background: #1b5e20; padding: 30px; border-radius: 10px; max-width: 500px; margin: 50px auto; }
        .lobby-box input { padding: 10px; font-size: 16px; margin: 10px 0; width: 80%; border-radius: 5px; border: none; }
        #table-code { background: #388e3c; padding: 15px; border-radius: 5px; margin: 20px 0; font-size: 20px; font-weight: bold; }
        #log { background: #1b5e20; padding: 10px; border-radius: 5px; margin: 20px auto; width: 80%; max-height: 300px; overflow-y: auto; text-align: left; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; background: #4caf50; color: white; font-weight: bold; }
        button:hover:not(:disabled) { background: #388e3c; }
        button:disabled { background: #666; cursor: not-allowed; }
        .leave { background: #d32f2f; }
        .leave:hover { background: #b71c1c; }
        .card { display: inline-block; margin: 5px; padding: 15px 20px; background: white; color: black; border-radius: 8px; font-size: 24px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .card.hidden { background: #1565c0; color: white; }
        .cards { margin: 20px 0; min-height: 80px; }
        .value { font-size: 16px; color: #ffeb3b; margin: 5px 0; }
    </style>
</head>
<body>
<h1>ðŸŽ° Blackjack</h1>

<div id="lobby">
    <div class="lobby-box">
        <h2>Welcome!</h2>
        <button onclick="connect('CREATE')">Create Table</button>
        <hr>
        <input id="code" placeholder="Enter 6-char code" maxlength="6">
        <button onclick="connect('JOIN ' + code.value.toUpperCase())">Join Table</button>
    </div>
</div>

<div id="game" class="hidden">
    <div id="table-code"></div>
    <h3>Dealer</h3>
    <div id="dval" class="value"></div>
    <div id="dcards" class="cards"></div>
    <h3>Player</h3>
    <div id="pval" class="value"></div>
    <div id="pcards" class="cards"></div>
    <button id="hit" onclick="send('HIT')" disabled>HIT</button>
    <button id="stand" onclick="send('STAND')" disabled>STAND</button>
    <button id="again" onclick="send('YES')" disabled>PLAY AGAIN</button>
    <button class="leave" onclick="leave()">LEAVE</button>
    <div id="log"></div>
</div>

<script>
let ws, play = false, pc = [], dc = [];

function connect(msg) {
    ws = new WebSocket("https://blackjack-dlw3.onrender.com");
    ws.onopen = () => ws.send(msg);
    ws.onmessage = async e => {
        const d = e.data;
        log(d);
        
        if (d.startsWith("TABLE_CREATED") || d.startsWith("TABLE_JOINED")) {
            lobby.classList.add("hidden");
            game.classList.remove("hidden");
            document.getElementById("table-code").textContent = "Code: " + d.split(" ")[1];
        } else if (d === "TABLE_NOT_FOUND") {
            alert("Table not found!");
        } else if (d === "TABLE_FULL") {
            alert("Table full!");
        } else if (d.startsWith("CARDS")) {
            const cards = d.split(" ")[1].split(",");
            for (let c of cards.slice(pc.length)) {
                add(pcards, c);
                await wait(400);
            }
            pc = cards;
            update(pval, pc);
        } else if (d === "DEALER_RESET") {
            dcards.innerHTML = "";
            dc = [];
            dval.textContent = "";
        } else if (d.startsWith("DEALER_INIT")) {
            const p = d.split(" ");
            dc = [p[1], p[2]];
            dcards.innerHTML = "";
            add(dcards, "ðŸ‚ ", true);
            await wait(400);
            add(dcards, p[2]);
            dval.textContent = "Showing: " + val(p[2]);
        } else if (d === "YOUR_TURN") {
            play = true;
            btns(true, true, false);
        } else if (d === "DEALER_REVEAL") {
            dcards.children[0].textContent = dc[0];
            dcards.children[0].classList.remove("hidden");
            update(dval, dc);
            await wait(500);
        } else if (d.startsWith("DEALER_CARD")) {
            const c = d.split(" ")[1];
            dc.push(c);
            add(dcards, c);
            await wait(400);
            update(dval, dc);
        } else if (d.startsWith("RESULT")) {
            play = false;
            btns(false, false, false);
            log((d.includes("WIN") ? "ðŸŽ‰" : d.includes("LOSE") ? "ðŸ˜ž" : "ðŸ¤") + " " + d.split(" ")[1]);
        } else if (d === "PLAY_AGAIN?") {
            play = false;
            btns(false, false, true);
        }
    };
}

function send(m) {
    if (ws.readyState !== 1) return;
    if (!play && m !== "YES") return;
    ws.send(m);
    log("> " + m);
    if (m === "HIT" || m === "STAND") {
        play = false;
        btns(false, false, false);
    } else if (m === "YES") {
        pc = dc = [];
        pcards.innerHTML = dcards.innerHTML = "";
        pval.textContent = dval.textContent = "";
    }
}

function leave() {
    ws.close();
    game.classList.add("hidden");
    lobby.classList.remove("hidden");
    pc = dc = [];
    pcards.innerHTML = dcards.innerHTML = "";
    pval.textContent = dval.textContent = "";
    document.getElementById("log").textContent = "";
}

function btns(h, s, a) {
    hit.disabled = !h;
    stand.disabled = !s;
    again.disabled = !a;
}

function add(el, txt, hid) {
    const d = document.createElement("div");
    d.className = "card" + (hid ? " hidden" : "");
    d.textContent = txt;
    el.appendChild(d);
}

function log(t) {
    document.getElementById("log").textContent += t + "\n";
    document.getElementById("log").scrollTop = 999999;
}

function wait(ms) {
    return new Promise(r => setTimeout(r, ms));
}

function val(c) {
    const v = c.slice(0, -1);
    return v === "A" ? 11 : ["J", "Q", "K"].includes(v) ? 10 : +v;
}

function sum(cards) {
    let s = 0, a = 0;
    for (let c of cards) {
        const v = c.slice(0, -1);
        if (v === "A") { s += 11; a++; }
        else s += ["J", "Q", "K"].includes(v) ? 10 : +v;
    }
    while (s > 21 && a > 0) { s -= 10; a--; }
    return s;
}

function update(el, cards) {
    const s = sum(cards);
    el.textContent = "Value: " + s + (s > 21 ? " - BUST!" : s === 21 ? " - BLACKJACK!" : "");
}
</script>
</body>
</html>