<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Blackjack</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            text-align: center;
            background: #2e7d32;
            color: white;
            font-family: Arial;
        }

        h1 {
            margin-bottom: 20px;
            color: #ffeb3b;
        }

        .hidden {
            display: none;
        }

        .box {
            background: #1b5e20;
            padding: 25px;
            margin: 20px auto;
            width: 420px;
            border-radius: 10px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            background: #4caf50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin: 8px;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .leave {
            background: #d32f2f;
        }

        .cards {
            min-height: 70px;
            margin: 15px;
        }

        .card {
            display: inline-block;
            margin: 4px;
            padding: 12px 16px;
            background: white;
            color: black;
            border-radius: 6px;
            font-size: 20px;
            font-weight: bold;
        }

        .hidden-card {
            background: #1565c0;
            color: #1565c0;
        }
    </style>
</head>

<body>
    <h1>ðŸŽ° Blackjack Live</h1>

    <!-- Lobby -->
    <div id="lobby" class="box">
        <button onclick="connectToServer('CREATE')">Create Table</button>
        <hr>
        <input id="tableCodeInput" placeholder="Table code" maxlength="6" style="text-transform:uppercase;">
        <button onclick="connectToServer('JOIN ' + tableCodeInput.value.toUpperCase())">Join Table</button>
    </div>

    <!-- Game -->
    <div id="gameBox" class="box hidden">
        <div id="tableCodeDisplay"></div>

        <h3>Dealer</h3>
        <div id="dealerHandValue"></div>
        <div id="dealerCardsContainer" class="cards"></div>

        <h3>Player</h3>
        <div id="playerHandValue"></div>
        <div id="playerCardsContainer" class="cards"></div>

        <button id="hitButton" onclick="sendPlayerCommand('HIT')" disabled>HIT</button>
        <button id="standButton" onclick="sendPlayerCommand('STAND')" disabled>STAND</button>
        <button id="playAgainButton" onclick="sendPlayerCommand('YES')" disabled>PLAY AGAIN</button>

        <br>
        <button class="leave" onclick="leaveTable()">LEAVE</button>
    </div>

    <script>
        const $ = id => document.getElementById(id);

        const lobbyBox = $("lobby");
        const gameBox = $("gameBox");

        const playerCardsContainer = $("playerCardsContainer");
        const dealerCardsContainer = $("dealerCardsContainer");

        const playerHandValue = $("playerHandValue");
        const dealerHandValue = $("dealerHandValue");

        const hitButton = $("hitButton");
        const standButton = $("standButton");
        const playAgainButton = $("playAgainButton");

        let websocket;
        let playerCards = [];
        let dealerCards = [];

        function connectToServer(message) {
            const protocol = location.protocol === "https:" ? "wss" : "ws";
            websocket = new WebSocket(`${protocol}://${location.host}`);

            websocket.onopen = () => websocket.send(message);

            websocket.onmessage = async event => {
                const [command, data] = event.data.split(" ", 2);

                switch (command) {

                    case "TABLE_CREATED":
                    case "TABLE_JOINED":
                        lobbyBox.classList.add("hidden");
                        gameBox.classList.remove("hidden");
                        $("tableCodeDisplay").textContent = "Code: " + data;
                        // Ensure all action buttons are disabled when joining a table
                        toggleButtons(false, false, false);
                        break;

                    case "TABLE_NOT_FOUND": alert("Table not found"); break;
                    case "TABLE_FULL": alert("Table full"); break;

                    case "DEALER_RESET":
                        dealerCards = playerCards = [];
                        dealerCardsContainer.innerHTML = playerCardsContainer.innerHTML = "";
                        dealerHandValue.textContent = playerHandValue.textContent = "";
                        // Reset buttons at the start of a new hand
                        toggleButtons(false, false, false);
                        break;

                    case "DEALER_INIT": {
                        const [firstCard, secondCard] = data.split(" ");
                        dealerCards = [firstCard, secondCard];
                        dealerCardsContainer.innerHTML = "";
                        addCardToContainer(dealerCardsContainer, "ðŸ‚ ", true);
                        await sleep(300);
                        addCardToContainer(dealerCardsContainer, secondCard);
                        dealerHandValue.textContent = "Showing: " + getCardValue(secondCard);
                        break;
                    }

                    case "CARDS":
                        playerCards = data.split(",");
                        renderCards(playerCardsContainer, playerCards);
                        updateHandValue(playerHandValue, playerCards);
                        break;

                    case "YOUR_TURN":
                        toggleButtons(true, true, false);
                        break;

                    case "DEALER_REVEAL":
                        dealerCardsContainer.children[0].classList.remove("hidden-card");
                        dealerCardsContainer.children[0].textContent = dealerCards[0];
                        updateHandValue(dealerHandValue, dealerCards);
                        break;

                    case "DEALER_CARD":
                        dealerCards.push(data);
                        addCardToContainer(dealerCardsContainer, data);
                        updateHandValue(dealerHandValue, dealerCards);
                        break;

                    case "RESULT": {
                        toggleButtons(false, false, false);
                        const parts = event.data.split(" ");
                        const result = parts[1]; // WIN, LOSE, or PUSH
                        const dealerCardsList = parts[3]?.split(",") || [];
                        dealerCards = dealerCardsList;
                        renderCards(dealerCardsContainer, dealerCards);
                        updateHandValue(dealerHandValue, dealerCards);
                        
                        // Display result to player
                        const resultMessage = result === "WIN" ? "ðŸŽ‰ HAI VINTO!" : 
                                             result === "PUSH" ? "ðŸ¤ PAREGGIO" : 
                                             "ðŸ˜ž HAI PERSO";
                        playerHandValue.textContent += " - " + resultMessage;
                        break;
                    }

                    case "PLAY_AGAIN?":
                        toggleButtons(false, false, true);
                        break;

                    case "PLAY_AGAIN_LOCK":
                        toggleButtons(false, false, false);
                        break;
                }
            };
        }

        function sendPlayerCommand(command) {
            if (!websocket) return;
            if (command === 'STAND') toggleButtons(false, false, false);
            websocket.send(command);
        }

        function toggleButtons(enableHit, enableStand, enablePlayAgain) {
            hitButton.disabled = !enableHit;
            standButton.disabled = !enableStand;
            playAgainButton.disabled = !enablePlayAgain;
        }

        function leaveTable() {
            websocket?.close();
            gameBox.classList.add("hidden");
            lobbyBox.classList.remove("hidden");
        }

        function addCardToContainer(container, card, hidden = false) {
            const cardDiv = document.createElement("div");
            cardDiv.className = "card" + (hidden ? " hidden-card" : "");
            cardDiv.textContent = card;
            container.appendChild(cardDiv);
        }

        function renderCards(container, cards) {
            container.innerHTML = "";
            cards.forEach(card => addCardToContainer(container, card));
        }

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function getCardValue(card) {
            const value = card.slice(0, -1);
            return value === "A" ? 11 : ["J", "Q", "K"].includes(value) ? 10 : +value;
        }

        function calculateHandValue(cards) {
            let total = 0, acesCount = 0;
            for (let card of cards) {
                let value = getCardValue(card);
                if (card[0] === "A") acesCount++;
                total += value;
            }
            while (total > 21 && acesCount--) total -= 10;
            return total;
        }

        function updateHandValue(element, cards) {
            const total = calculateHandValue(cards);
            element.textContent = "Value: " + total + (total > 21 ? " BUST" : total === 21 ? " BLACKJACK" : "");
        }
    </script>

</body>

</html>