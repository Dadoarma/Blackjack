<!DOCTYPE html>
<html>
<head>
    <title>Blackjack</title>
    <style>
        body { 
            font-family: Arial; 
            background: #2e7d32; 
            color: white; 
            text-align: center; 
            padding: 20px; 
        }
        .hidden { display: none; }
        .lobby-box { 
            background: #1b5e20; 
            padding: 25px; 
            border-radius: 8px; 
            max-width: 350px; 
            margin: 40px auto; 
        }
        .lobby-box input { 
            padding: 8px; 
            font-size: 15px; 
            margin: 8px 0; 
            width: 80%; 
            border-radius: 4px; 
            border: none; 
        }
        #table-code { 
            background: #388e3c; 
            padding: 8px; 
            border-radius: 4px; 
            margin: 8px 0; 
            font-size: 16px; 
        }
        button { 
            margin: 5px; 
            padding: 8px 16px; 
            font-size: 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background: #4caf50; 
            color: white; 
        }
        button:hover:not(:disabled) { background: #388e3c; }
        button:disabled { background: #666; cursor: not-allowed; }
        .leave { background: #d32f2f; }
        .card { 
            display: inline-block; 
            margin: 4px; 
            padding: 12px 16px; 
            background: white; 
            color: black; 
            border-radius: 6px; 
            font-size: 22px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }
        .card.hidden { background: #1565c0; color: white; }
        .cards { margin: 15px 0; min-height: 70px; }
        .value { font-size: 16px; color: #ffeb3b; margin: 8px 0; }
    </style>
</head>
<body>
<h1>ðŸŽ° Blackjack</h1>

<!-- LOBBY -->
<div id="lobby">
    <div class="lobby-box">
        <h2>Benvenuto!</h2>
        <button onclick="crea()">Crea Tavolo</button>
        <hr>
        <input id="code" placeholder="Codice 6 caratteri" maxlength="6">
        <button onclick="unisciti()">Unisciti</button>
    </div>
</div>

<!-- GIOCO -->
<div id="game" class="hidden">
    <div id="table-code"></div>
    <h3>Banco</h3>
    <div id="dval" class="value"></div>
    <div id="dcards" class="cards"></div>
    <h3>Giocatore</h3>
    <div id="pval" class="value"></div>
    <div id="pcards" class="cards"></div>
    <div>
        <button id="hit" onclick="cmd('HIT')" disabled>CARTA</button>
        <button id="stand" onclick="cmd('STAND')" disabled>STAI</button>
        <button id="again" onclick="cmd('YES')" disabled>ANCORA</button>
    </div>
    <button class="leave" onclick="esci()">ESCI</button>
</div>

<script>
let ws, turno = false, pc = [], dc = [];

// Crea tavolo: Inizializza la connessione WebSocket inviando il comando 'CREATE'
function crea() {
    connetti('CREATE');
}

// Unisciti a tavolo: Legge il codice e invia il comando 'JOIN XXXXXX'
function unisciti() {
    const c = document.getElementById('code').value.toUpperCase();
    if (c.length === 6) connetti('JOIN ' + c);
    else alert('Inserisci 6 caratteri');
}

// Connessione WebSocket principale
function connetti(msg) {
    // Usa l'URL e il protocollo del browser corrente (wss: se HTTPS, ws: altrimenti)
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const host = window.location.host;
    ws = new WebSocket(`${protocol}//${host}`);
    
    // Appena la connessione Ã¨ aperta, invia il messaggio iniziale
    ws.onopen = () => ws.send(msg);
    
    // Gestione messaggi ricevuti dal server
    ws.onmessage = async e => {
        const d = e.data;
        
        // Gestione Lobby/Tavolo
        if (d.startsWith("TABLE_")) {
            const cod = d.split(" ")[1];
            if (d.includes("CREATED") || d.includes("JOINED")) {
                mostra(cod);
            } else if (d.includes("NOT_FOUND")) {
                alert("Tavolo non trovato!");
            } else if (d.includes("FULL")) {
                alert("Tavolo pieno!");
            }
        // Carte Giocatore
        } else if (d.startsWith("CARDS")) {
            const carte = d.split(" ")[1].split(",");
            // Aggiunge le carte mancanti con un piccolo ritardo per l'animazione
            for (let i = pc.length; i < carte.length; i++) {
                add('pcards', carte[i]);
                await wait(300);
            }
            pc = carte;
            upd('pval', pc); // Aggiorna punteggio giocatore
        // Reset Banco
        } else if (d === "DEALER_RESET") {
            document.getElementById('dcards').innerHTML = "";
            dc = [];
            document.getElementById('dval').textContent = "";
        // Inizializzazione Banco
        } else if (d.startsWith("DEALER_INIT")) {
            const p = d.split(" ");
            dc = [p[1], p[2]];
            document.getElementById('dcards').innerHTML = "";
            add('dcards', "ðŸ‚ ", true); // Carta coperta
            await wait(300);
            add('dcards', p[2]); // Carta scoperta
            document.getElementById('dval').textContent = "Mostra: " + val(p[2]);
        // Ãˆ il tuo turno
        } else if (d === "YOUR_TURN") {
            turno = true;
            btn(true, true, false); // Abilita HIT e STAND
        // Il Banco rivela la carta coperta
        } else if (d === "DEALER_REVEAL") {
            const cards = document.getElementById('dcards').children;
            cards[0].textContent = dc[0];
            cards[0].classList.remove("hidden");
            upd('dval', dc); // Aggiorna punteggio banco
            await wait(400);
        // Il Banco pesca
        } else if (d.startsWith("DEALER_CARD")) {
            const c = d.split(" ")[1];
            dc.push(c);
            add('dcards', c);
            await wait(300);
            upd('dval', dc);
        // Risultato del round
        } else if (d.startsWith("RESULT")) {
            turno = false;
            btn(false, false, false);
            // Qui potresti mostrare un messaggio piÃ¹ esplicito per il risultato
        } else if (d === "PLAY_AGAIN?") {
            turno = false;
            btn(false, false, true); // Abilita il bottone "ANCORA"
        }
    };
}

// Mostra interfaccia di gioco
function mostra(cod) {
    document.getElementById('lobby').classList.add("hidden");
    document.getElementById('game').classList.remove("hidden");
    document.getElementById('table-code').textContent = "Codice: " + cod;
}

// Invia comando di gioco
function cmd(c) {
    if (ws.readyState !== 1 || (!turno && c !== "YES")) return;
    ws.send(c);
    if (c === "HIT" || c === "STAND") {
        turno = false;
        btn(false, false, false);
    } else if (c === "YES") {
        // Reset l'interfaccia se si gioca di nuovo
        pc = dc = [];
        document.getElementById('pcards').innerHTML = "";
        document.getElementById('dcards').innerHTML = "";
        document.getElementById('pval').textContent = "";
        document.getElementById('dval').textContent = "";
    }
}

// Esci dal tavolo
function esci() {
    if (ws) ws.close();
    document.getElementById('game').classList.add("hidden");
    document.getElementById('lobby').classList.remove("hidden");
    // Reset dello stato locale
    pc = dc = [];
    document.getElementById('pcards').innerHTML = "";
    document.getElementById('dcards').innerHTML = "";
    document.getElementById('pval').textContent = "";
    document.getElementById('dval').textContent = "";
}

// Abilita/disabilita bottoni di gioco
function btn(h, s, a) {
    document.getElementById('hit').disabled = !h;
    document.getElementById('stand').disabled = !s;
    document.getElementById('again').disabled = !a;
}

// Aggiungi un elemento carta al DOM
function add(el, txt, hid = false) {
    const d = document.createElement("div");
    d.className = "card" + (hid ? " hidden" : "");
    d.textContent = txt;
    document.getElementById(el).appendChild(d);
}

// Promessa per ritardare l'esecuzione (usato per animazioni)
function wait(ms) {
    return new Promise(r => setTimeout(r, ms));
}

// Valore carta singola (solo il numero)
function val(c) {
    const v = c.slice(0, -1);
    return v === "A" ? 11 : ["J", "Q", "K"].includes(v) ? 10 : +v;
}

// Calcola punteggio (logica Assi come 1 o 11)
function calc(cards) {
    let s = 0, a = 0;
    for (let c of cards) {
        const v = c.slice(0, -1);
        if (v === "A") { s += 11; a++; }
        else s += ["J", "Q", "K"].includes(v) ? 10 : +v;
    }
    while (s > 21 && a > 0) { s -= 10; a--; }
    return s;
}

// Aggiorna la visualizzazione del punteggio
function upd(el, cards) {
    const s = calc(cards);
    document.getElementById(el).textContent = "Valore: " + s + 
        (s > 21 ? " - SBALLATO!" : s === 21 ? " - BLACKJACK!" : "");
}
</script>
</body>
</html>