<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Blackjack</title>
   <style>
/* Palette moderna e font piÃ¹ leggibile */
body {
    margin: 0;
    padding: 20px;
    text-align: center;
    background: linear-gradient(135deg, #1b5e20, #2e7d32);
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Titolo elegante con ombra */
h1 {
    margin-bottom: 20px;
    color: #ffeb3b;
    font-size: 3em;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
}

/* Nascondere elementi */
.hidden {
    display: none;
}

/* Box moderno con ombra e bordi arrotondati */
.box {
    background: rgba(27, 94, 32, 0.95);
    padding: 30px;
    margin: 20px auto;
    width: 420px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.box:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.5);
}

/* Pulsanti moderni */
button {
    padding: 12px 28px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(145deg, #4caf50, #66bb6a);
    color: #fff;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin: 8px;
    box-shadow: 0 4px #388e3c;
    transition: all 0.2s ease;
}
button:hover:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 2px #388e3c;
}
button:disabled {
    background: #888;
    cursor: not-allowed;
    box-shadow: none;
}

/* Pulsante leave rosso moderno */
.leave {
    background: linear-gradient(145deg, #d32f2f, #e53935);
    box-shadow: 0 4px #9f2424;
}
.leave:hover:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 2px #9f2424;
}

/* Container carte */
.cards {
    min-height: 80px;
    margin: 15px 0;
}

/* Carte con effetto moderno e ombra */
.card {
    display: inline-block;
    margin: 6px;
    padding: 14px 18px;
    background: #fff;
    color: #000;
    border-radius: 10px;
    font-size: 22px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.4);
}

/* Carte coperte */
.hidden-card {
    background: linear-gradient(135deg, #1565c0, #1e88e5);
    color: #1565c0;
    position: relative;
    font-weight: bold;
}
.hidden-card::after {
    content: "â™ ";
    color: rgba(255,255,255,0.8);
    font-size: 1.5em;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Input moderno */
input {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    text-transform: uppercase;
    margin: 10px 0;
    width: 70%;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    transition: box-shadow 0.3s ease;
}
input:focus {
    outline: none;
    box-shadow: 0 0 8px #ffeb3b;
}
</style>
</head>

<body>
    <h1>ðŸŽ° Blackjack Live</h1>

    <!-- Lobby -->
    <div id="lobby" class="box">
        <button onclick="connectToServer('CREATE')">Create Table</button>
        <hr>
        <input id="tableCodeInput" placeholder="Table code" maxlength="6" style="text-transform:uppercase;">
        <button onclick="connectToServer('JOIN ' + tableCodeInput.value.toUpperCase())">Join Table</button>
    </div>

    <!-- Game -->
    <div id="gameBox" class="box hidden">
        <div id="tableCodeDisplay"></div>

        <h3>Dealer</h3>
        <div id="dealerHandValue"></div>
        <div id="dealerCardsContainer" class="cards"></div>

        <h3>Player</h3>
        <div id="playerHandValue"></div>
        <div id="playerCardsContainer" class="cards"></div>

        <button id="hitButton" onclick="sendPlayerCommand('HIT')" disabled>HIT</button>
        <button id="standButton" onclick="sendPlayerCommand('STAND')" disabled>STAND</button>
        <button id="playAgainButton" onclick="sendPlayerCommand('YES')" disabled>PLAY AGAIN</button>

        <br>
        <button class="leave" onclick="leaveTable()">LEAVE</button>
    </div>

    <script>
        const $ = id => document.getElementById(id);

        const lobbyBox = $("lobby");
        const gameBox = $("gameBox");

        const playerCardsContainer = $("playerCardsContainer");
        const dealerCardsContainer = $("dealerCardsContainer");

        const playerHandValue = $("playerHandValue");
        const dealerHandValue = $("dealerHandValue");

        const hitButton = $("hitButton");
        const standButton = $("standButton");
        const playAgainButton = $("playAgainButton");

        let websocket;
        let playerCards = [];
        let dealerCards = [];

        function connectToServer(message) {
            const protocol = location.protocol === "https:" ? "wss" : "ws";
            websocket = new WebSocket(`${protocol}://${location.host}`);

            websocket.onopen = () => websocket.send(message);

            websocket.onmessage = async event => {
                const [command, data] = event.data.split(" ", 2);

                switch (command) {

                    case "TABLE_CREATED":
                    case "TABLE_JOINED":
                        lobbyBox.classList.add("hidden");
                        gameBox.classList.remove("hidden");
                        $("tableCodeDisplay").textContent = "Code: " + data;
                        // Ensure all action buttons are disabled when joining a table
                        toggleButtons(false, false, false);
                        break;

                    case "TABLE_NOT_FOUND": alert("Table not found"); break;
                    case "TABLE_FULL": alert("Table full"); break;

                    case "DEALER_RESET":
                        dealerCards = playerCards = [];
                        dealerCardsContainer.innerHTML = playerCardsContainer.innerHTML = "";
                        dealerHandValue.textContent = playerHandValue.textContent = "";
                        // Reset buttons at the start of a new hand
                        toggleButtons(false, false, false);
                        break;

                    case "DEALER_INIT": {
                        const [firstCard, secondCard] = data.split(" ");
                        dealerCards = [firstCard, secondCard];
                        dealerCardsContainer.innerHTML = "";
                        addCardToContainer(dealerCardsContainer, "ðŸ‚ ", true);
                        await sleep(300);
                        addCardToContainer(dealerCardsContainer, secondCard);
                        dealerHandValue.textContent = "Showing: " + getCardValue(secondCard);
                        break;
                    }

                    case "CARDS":
                        playerCards = data.split(",");
                        renderCards(playerCardsContainer, playerCards);
                        updateHandValue(playerHandValue, playerCards);
                        break;

                    case "YOUR_TURN":
                        toggleButtons(true, true, false);
                        break;

                    case "DEALER_REVEAL":
                        dealerCardsContainer.children[0].classList.remove("hidden-card");
                        dealerCardsContainer.children[0].textContent = dealerCards[0];
                        updateHandValue(dealerHandValue, dealerCards);
                        break;

                    case "DEALER_CARD":
                        dealerCards.push(data);
                        addCardToContainer(dealerCardsContainer, data);
                        updateHandValue(dealerHandValue, dealerCards);
                        break;

                    case "RESULT": {
                        toggleButtons(false, false, false);
                        const parts = event.data.split(" ");
                        const result = parts[1]; // WIN, LOSE, or PUSH
                        const dealerCardsList = parts[3]?.split(",") || [];
                        dealerCards = dealerCardsList;
                        renderCards(dealerCardsContainer, dealerCards);
                        updateHandValue(dealerHandValue, dealerCards);
                        
                        // Display result to player
                        const resultMessage = result === "WIN" ? "ðŸŽ‰ HAI VINTO!" : 
                                             result === "PUSH" ? "ðŸ¤ PAREGGIO" : 
                                             "ðŸ˜ž HAI PERSO";
                        playerHandValue.textContent += " - " + resultMessage;
                        break;
                    }

                    case "PLAY_AGAIN?":
                        toggleButtons(false, false, true);
                        break;

                    case "PLAY_AGAIN_LOCK":
                        toggleButtons(false, false, false);
                        break;
                }
            };
        }

        function sendPlayerCommand(command) {
            if (!websocket) return;
            if (command === 'STAND') toggleButtons(false, false, false);
            websocket.send(command);
        }

        function toggleButtons(enableHit, enableStand, enablePlayAgain) {
            hitButton.disabled = !enableHit;
            standButton.disabled = !enableStand;
            playAgainButton.disabled = !enablePlayAgain;
        }

        function leaveTable() {
            websocket?.close();
            gameBox.classList.add("hidden");
            lobbyBox.classList.remove("hidden");
        }

        function addCardToContainer(container, card, hidden = false) {
            const cardDiv = document.createElement("div");
            cardDiv.className = "card" + (hidden ? " hidden-card" : "");
            cardDiv.textContent = card;
            container.appendChild(cardDiv);
        }

        function renderCards(container, cards) {
            container.innerHTML = "";
            cards.forEach(card => addCardToContainer(container, card));
        }

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function getCardValue(card) {
            const value = card.slice(0, -1);
            return value === "A" ? 11 : ["J", "Q", "K"].includes(value) ? 10 : +value;
        }

        function calculateHandValue(cards) {
            let total = 0, acesCount = 0;
            for (let card of cards) {
                let value = getCardValue(card);
                if (card[0] === "A") acesCount++;
                total += value;
            }
            while (total > 21 && acesCount--) total -= 10;
            return total;
        }

        function updateHandValue(element, cards) {
            const total = calculateHandValue(cards);
            element.textContent = "Value: " + total + (total > 21 ? " BUST" : total === 21 ? " BLACKJACK" : "");
        }
    </script>

</body>

</html>